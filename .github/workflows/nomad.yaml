on:
  push:
    branches:
      - master

jobs:
  # JOB to run change detection
  changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      jobs: ${{ steps.filter.outputs.nomadjobs_files }}
      volumes: ${{ steps.filter_volumes.outputs.volumes_files }}
    steps:
    - name: 'Checkout'
      uses: 'actions/checkout@v6'

    - uses: dorny/paths-filter@v3
      id: filter_volumes
      with:
        list-files: 'json'
        filters: |
          volumes:
            - 'nomad_jobs/**/volume.hcl'
            - 'nomad_jobs/**/*-volume.hcl'

    - uses: dorny/paths-filter@v3
      id: filter
      with:
        list-files: 'json'
        filters: |
          nomadjobs:
            # Updated paths based on directory restructure
            - 'nomad_jobs/media-stack/plex/*.job'
            - 'nomad_jobs/media-stack/radarr/*.job'
            - 'nomad_jobs/media-stack/lidarr/*.job'
            - 'nomad_jobs/media-stack/overseerr/*.job'
            - 'nomad_jobs/storage-backends/postgres/*.job'
            - 'nomad_jobs/storage-backends/redis/*.job'
            - 'nomad_jobs/storage-backends/pgvector/*.job'
            - 'nomad_jobs/core-infra/coredns/*.job'
            - 'nomad_jobs/storage-backends/iscsi-csi-plugin/*.job'
            - 'nomad_jobs/media-stack/sabnzbd/*.job'
            - 'nomad_jobs/core-infra/smtp/*.job'
            - 'nomad_jobs/ai-ml/ollama/*.job'
            - 'nomad_jobs/ai-ml/open-webui/*.job'
            - 'nomad_jobs/misc/gcp-dns-updater/*.job'
            - 'nomad_jobs/core-infra/tailscale-este/*.job'
            - 'nomad_jobs/core-infra/traefik/*.job'
            - 'nomad_jobs/core-infra/iscsi-csi-plugin/*.job'
            - 'nomad_jobs/observability/alertmanager/*.job'
            - 'nomad_jobs/observability/prometheus/*.job'
            - 'nomad_jobs/ai-ml/radbot/*.job'
            - 'nomad_jobs/personal-cloud/ntfy/*.job'

  add_volumes:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.volumes != '[]'
    continue-on-error: true
    strategy:
      matrix:
        job: ${{ fromJSON(needs.changes.outputs.volumes ) }}

    steps:
    - name: 'Checkout'
      uses: 'actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd' # v6

    - name: Connect to Tailscale
      uses: tailscale/github-action@v4
      with:
        oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
        tags: tag:github-actions
        args: --accept-dns=true

    - name: Setup Nomad
      uses: hashicorp/setup-nomad@v1.0.0
      with:
        version: "1.10.4"

    - name: deploy
      shell: bash
      run: |
        # Extract volume ID from the HCL file
        VOLUME_ID=$(grep '^id' ${{ matrix.job }} | head -1 | sed 's/.*= *"\(.*\)"/\1/')
        # Skip if volume already exists
        if nomad volume status "$VOLUME_ID" > /dev/null 2>&1; then
          echo "Volume '$VOLUME_ID' already exists, skipping creation"
        else
          echo "Creating volume '$VOLUME_ID'"
          nomad volume create ${{ matrix.job }}
        fi
      env:
        NOMAD_ADDR: '${{ secrets.NOMAD_ADDR }}'

  deploy_jobs:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.jobs != '[]'
    continue-on-error: true
    strategy:
      matrix:
        job: ${{ fromJSON(needs.changes.outputs.jobs ) }}

    steps:
    - name: 'Checkout'
      uses: 'actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd' # v6

    - name: Connect to Tailscale
      uses: tailscale/github-action@v4
      with:
        oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
        tags: tag:github-actions
        args: --accept-dns=true

    - name: Setup Nomad
      uses: hashicorp/setup-nomad@v1.0.0
      with:
        version: "1.10.4"

    - name: deploy
      shell: bash
      run: |
        nomad job run ${{ matrix.job }} # Removed -var flags
      env:
        NOMAD_ADDR: '${{ secrets.NOMAD_ADDR }}'
        NOMAD_VAR_region: 'home'
        NOMAD_VAR_tld: '${{ secrets.NOMAD_VAR_tld }}' # Corrected case
        NOMAD_VAR_shared_dir: '/home/shared/'
        NOMAD_VAR_downloads_dir: '/home/sabnzbd/downloads'
        NOMAD_VAR_music_dir: '/home/media/Music'
        NOMAD_VAR_movies_dir: '/home/media/Movies'
        NOMAD_VAR_books_dir: '/home/media/Books'
        NOMAD_VAR_tv_dir: '/home/media/TV'
        NOMAD_VAR_media_dir: '/home/media'
        NOMAD_VAR_hass_key: '${{ secrets.NOMAD_VAR_hass_key }}' # Corrected case
        NOMAD_VAR_hass_ip: '${{ secrets.NOMAD_VAR_hass_ip }}'
        NOMAD_VAR_github_pat: ${{ secrets.NOMAD_VAR_github_pat }} # Corrected case
        NOMAD_VAR_datacenters_all: '["dc1", "public"]'
        NOMAD_VAR_datacenters_dc1: '["dc1"]'
        NOMAD_VAR_datacenters_public: '["public"]'
        NOMAD_VAR_tailscale_auth: '${{ secrets.NOMAD_VAR_tailscale_auth }}' # Corrected case
        NOMAD_VAR_tailscale_auth_este: '${{ secrets.NOMAD_VAR_tailscale_auth_este }}' # Corrected case
        NOMAD_VAR_oauth_client_id: '${{ secrets.NOMAD_VAR_oauth_client_id }}' # Corrected case
        NOMAD_VAR_oauth_client_secret: '${{ secrets.NOMAD_VAR_oauth_client_secret }}' # Corrected case
        NOMAD_VAR_oauth_secret: '${{ secrets.NOMAD_VAR_oauth_secret }}' # Corrected case
        NOMAD_VAR_oauth_emails: '${{ secrets.NOMAD_VAR_oauth_emails }}' # Corrected case
        NOMAD_VAR_pushover_user_key: '${{ secrets.NOMAD_VAR_pushover_user_key }}' # Corrected case
        NOMAD_VAR_pushover_token: '${{ secrets.NOMAD_VAR_pushover_token }}'
        NOMAD_VAR_ssh_id: '${{ secrets.NOMAD_VAR_ssh_id }}' # Corrected case
        NOMAD_VAR_truenas_api_key: '${{ secrets.NOMAD_VAR_truenas_api_key }}' # Corrected case
        NOMAD_VAR_gh_access_token: '${{ secrets.NOMAD_VAR_gh_access_token }}' # Corrected case
        NOMAD_VAR_ollama_data_dir: '/home/shared/ollama'
        NOMAD_VAR_ollama_base_url: 'http://ollama.service.consul:11434'
        NOMAD_VAR_webui_secret_key: '${{ secrets.NOMAD_VAR_webui_secret_key }}' # Corrected case
        NOMAD_VAR_datacenter: 'dc1'
        NOMAD_VAR_dns_server_ip: '192.168.50.2'
        # Added missing variables
        NOMAD_VAR_aws_access_key: ${{ secrets.NOMAD_VAR_aws_access_key }}
        NOMAD_VAR_aws_secret_key: ${{ secrets.NOMAD_VAR_aws_secret_key }}
        NOMAD_VAR_bedrock_aws_region: ${{ secrets.NOMAD_VAR_bedrock_aws_region }}
        NOMAD_VAR_gcp_dns_admin: ${{ secrets.NOMAD_VAR_gcp_dns_admin }}
        NOMAD_VAR_gemini_api_key: ${{ secrets.NOMAD_VAR_gemini_api_key }}
        NOMAD_VAR_litellm_master_key: ${{ secrets.NOMAD_VAR_litellm_master_key }}
        NOMAD_VAR_manyfold_secret_key: ${{ secrets.NOMAD_VAR_manyfold_secret_key }}
        NOMAD_VAR_postgres_pass: ${{ secrets.NOMAD_VAR_postgres_pass }}
        NOMAD_VAR_truenas_iscsi_pass: ${{ secrets.NOMAD_VAR_truenas_iscsi_pass }}
        # Added gcp_project_id
        NOMAD_VAR_gcp_project_id: ${{ secrets.NOMAD_VAR_gcp_project_id }}
        # GitHub PAT is now stored securely in secrets
        NOMAD_VAR_truenass_iscsi_pass: ${{ secrets.NOMAD_VAR_truenass_iscsi_pass }} # Note potential typo in name
        NOMAD_VAR_dns_zone: ${{ secrets.NOMAD_VAR_dns_zone }}
        NOMAD_VAR_ingress_ip: ${{ secrets.NOMAD_VAR_ingress_ip }}
        NOMAD_VAR_radbot_credential_key: ${{ secrets.NOMAD_VAR_radbot_credential_key }}
        NOMAD_VAR_radbot_admin_token: ${{ secrets.NOMAD_VAR_radbot_admin_token }}
